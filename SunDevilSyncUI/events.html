<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Events - Sun Devil Central</title>
    <meta name="description" content="Browse upcoming events at ASU">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
</head>

<body>
    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="logo">üî± Sun Devil Central</div>
        <ul class="top-nav-menu">
            <li><a href="index.html">Home</a></li>
            <li><a href="groups.html">Groups</a></li>
            <li><a href="events.html" class="active">Events</a></li>
            <li><a href="badges.html">Badges</a></li>
            <li><a href="verify.html">Verify Badge</a></li>
            <li><a href="admin.html">Admin</a></li>
        </ul>
        <div class="top-nav-right">
            <span class="nav-icon" title="Search">üîç</span>
            <span class="nav-icon" title="Bookmarks">üîñ</span>
            <span class="nav-icon" title="Notifications">üîî<span class="badge">3</span></span>
            <span class="nav-icon" title="My Account">üë§</span>
        </div>
    </nav>

    <div class="page-wrapper">
        <main class="main-content">
            <div class="section-header">
                <h1 class="section-title">Events</h1>
                <span class="text-secondary" id="event-count">Loading...</span>
            </div>

            <section class="mb-3" id="my-events-section" style="display: none;">
                <div class="section-header">
                    <h2 class="section-title">My Events</h2>
                    <span class="text-secondary" id="my-event-count"></span>
                </div>
                <div id="my-events-list"></div>
            </section>

            <section>
                <div class="section-header">
                    <h2 class="section-title">All Events</h2>
                </div>

                <!-- Search Bar -->
                <div class="search-bar">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" id="search-input"
                        placeholder="Search events by name, description, or host...">
                </div>

                <!-- Filters -->
                <div class="filters">
                    <div class="grid grid-4">
                        <div class="filter-group">
                            <label class="filter-label">Event Type</label>
                            <select class="filter-select" id="type-filter">
                                <option value="">All Types</option>
                                <option value="Workshop">Workshop</option>
                                <option value="Club Meeting">Club Meeting</option>
                                <option value="Social">Social</option>
                                <option value="Competition">Competition</option>
                                <option value="Career Fair">Career Fair</option>
                                <option value="Festival">Festival</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Location Type</label>
                            <select class="filter-select" id="location-filter">
                                <option value="">All Locations</option>
                                <option value="In-Person">In-Person</option>
                                <option value="Virtual">Virtual</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Campus</label>
                            <select class="filter-select" id="campus-filter">
                                <option value="">All Campuses</option>
                                <option value="Tempe">Tempe</option>
                                <option value="Polytechnic">Polytechnic</option>
                                <option value="Online">Online</option>
                                <option value="Off-Campus">Off-Campus</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">&nbsp;</label>
                            <button class="btn btn-outline" id="clear-filters">Clear Filters</button>
                        </div>
                    </div>
                </div>

                <!-- Events List -->
                <div class="mt-2" id="events-list">
                    <!-- Events will be loaded here -->
                </div>

                <!-- Empty State -->
                <div class="empty-state hidden" id="empty-state">
                    <div class="empty-state-icon">üéâ</div>
                    <h3 class="empty-state-title">No events found</h3>
                    <p class="empty-state-description">Try adjusting your search or filters</p>
                    <button class="btn btn-primary" id="reset-search">Reset Search</button>
                </div>
            </section>
        </main>
    </div>

    <script src="js/main.js"></script>
    <script>
        let allEvents = [];
        let filteredEvents = [];
        let myRsvpIds = [];
        let myEvents = [];

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await (window.authReady || auth.checkAuth());
                if (currentUser) {
                    myRsvpIds = await api.get('/my-rsvps') || [];
                }

                allEvents = await api.get('/events') || [];

                // Sort by date
                allEvents.sort((a, b) => new Date(a.date) - new Date(b.date));

                filteredEvents = [...allEvents];
                displayEvents(filteredEvents);
                updateEventCount(filteredEvents.length);
                bindRsvpButtons();
                renderMyEvents();
            } catch (error) {
                console.error('Error loading events:', error);
            }

            // Setup event listeners
            document.getElementById('search-input').addEventListener('input', handleSearch);
            document.getElementById('type-filter').addEventListener('change', applyFilters);
            document.getElementById('location-filter').addEventListener('change', applyFilters);
            document.getElementById('campus-filter').addEventListener('change', applyFilters);
            document.getElementById('clear-filters').addEventListener('click', clearFilters);
            document.getElementById('reset-search').addEventListener('click', clearFilters);
        });

        function renderMyEvents() {
            const section = document.getElementById('my-events-section');
            const list = document.getElementById('my-events-list');
            const count = document.getElementById('my-event-count');

            if (!currentUser) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            myEvents = allEvents.filter(e => myRsvpIds.includes(e.id));
            count.textContent = `${myEvents.length} registered`;

            if (myEvents.length === 0) {
                list.innerHTML = '<p class="text-secondary">You have not RSVP\'d to any events yet.</p>';
                return;
            }

            list.innerHTML = myEvents.map(eventCard).join('');
        }

        function displayEvents(events) {
            const list = document.getElementById('events-list');
            const emptyState = document.getElementById('empty-state');

            if (events.length === 0) {
                list.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            list.classList.remove('hidden');
            emptyState.classList.add('hidden');

            list.innerHTML = events.map(eventCard).join('');
        }

        function handleSearch(e) {
            const searchTerm = e.target.value.toLowerCase();
            filteredEvents = allEvents.filter(event =>
                event.title.toLowerCase().includes(searchTerm) ||
                event.description.toLowerCase().includes(searchTerm) ||
                event.hostGroup.toLowerCase().includes(searchTerm) ||
                event.tags.some(tag => tag.toLowerCase().includes(searchTerm))
            );
            applyFilters();
        }

        function applyFilters() {
            const type = document.getElementById('type-filter').value;
            const location = document.getElementById('location-filter').value;
            const campus = document.getElementById('campus-filter').value;

            let filtered = [...filteredEvents];

            if (type) {
                filtered = filtered.filter(event => event.eventType === type);
            }

            if (location) {
                filtered = filtered.filter(event => event.locationType === location);
            }

            if (campus) {
                filtered = filtered.filter(event => event.campus === campus);
            }

            displayEvents(filtered);
            updateEventCount(filtered.length);
            bindRsvpButtons();
        }

        function clearFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('type-filter').value = '';
            document.getElementById('location-filter').value = '';
            document.getElementById('campus-filter').value = '';
            filteredEvents = [...allEvents];
            displayEvents(filteredEvents);
            updateEventCount(filteredEvents.length);
            bindRsvpButtons();
        }

        function updateEventCount(count) {
            document.getElementById('event-count').textContent = `${count} events`;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function bindRsvpButtons() {
            document.querySelectorAll('.rsvp-toggle').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const eventId = Number(btn.dataset.eventId);
                    const isCurrentlyRsvpd = myRsvpIds.includes(eventId);
                    const result = await toggleEventRSVP(eventId);
                    if (!result) return;
                    const status = result.status;

                    const eventObj = allEvents.find(e => e.id === eventId);
                    if (status === 'confirmed' && !isCurrentlyRsvpd) {
                        myRsvpIds.push(eventId);
                        if (eventObj) {
                            eventObj.spotsLeft = Math.max(0, eventObj.spotsLeft - 1);
                            eventObj.attendees += 1;
                        }
                    } else if (status === 'cancelled' && isCurrentlyRsvpd) {
                        myRsvpIds = myRsvpIds.filter(id => id !== eventId);
                        if (eventObj) {
                            eventObj.spotsLeft += 1;
                            eventObj.attendees = Math.max(0, eventObj.attendees - 1);
                        }
                    }
                    renderMyEvents();
                    applyFilters();
                });
            });
        }

        function eventCard(event) {
            const isRSVPd = myRsvpIds.includes(event.id);
            const isFull = event.spotsLeft <= 0 && !isRSVPd;
            const rsvpLabel = isRSVPd ? '‚úì RSVP\'d' : isFull ? 'Full' : 'RSVP';
            const rsvpClass = isRSVPd ? 'btn-outline' : 'btn-primary';
            const rsvpDisabledAttr = isFull ? 'disabled' : '';

            return `
                <div class="card event-card mb-2">
                    <div class="event-card-image"></div>
                    <div class="event-card-content">
                        <div class="event-card-header">
                            <div>
                                <h3 class="event-card-title">${event.title}</h3>
                                <div class="event-card-date">üìÖ ${formatDate(event.date)} at ${event.time}</div>
                                <div class="event-card-location">üìç ${event.location}</div>
                            </div>
                            ${event.isFree ? '<span class="event-free-tag">FREE</span>' : ''}
                        </div>
                        <p class="event-card-description">${event.description}</p>
                        <div class="tags">
                            <span class="tag tag-primary">${event.eventType}</span>
                            ${event.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                        </div>
                        <div class="event-card-footer">
                            <span class="event-host">Hosted by ${event.hostGroup}</span>
                            <div>
                                ${event.spotsLeft > 0 ?
                    `<span class="event-spots">${event.spotsLeft} spots left</span>` :
                    `<span class="event-spots" style="color: #EF4444;">Full</span>`
                }
                                <button class="btn btn-sm ${rsvpClass} ml-1 rsvp-toggle" data-event-id="${event.id}" ${rsvpDisabledAttr}>
                                    ${rsvpLabel}
                                </button>
                                <a href="event-detail.html?id=${event.id}" class="btn btn-sm btn-outline ml-1">
                                    Details
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    </script>
</body>

</html>
